# Anonymous Types

## Problem

Anonymous types like `var x = new { Test = "Cat" }` end up being types generated by the compiler. They're also used a lot in LINQ, both written by developers and generated by compilers when using the query syntax. However these types will only exist in the client assembly, the server will not understand them so we need a way of transmitting the same data structure to the server.

## Solution

Convert anonymous types to tuples. See implementation in `AnonymousTypeRewriter.cs`.

* Find any anonymous type
* Select an appropriate tuple
* Get a constructor, build an anonymous type to tuple delegate
* Visit NewExpr, ConstantExpr, LambdaExpr, MethodCallExpr, MemberExpr, ParameterExpr
* Stick on a conversion at the end back into the anonymous type (client-side)?


## Further problems
* Nested anonymous types. (Maybe I need some kinda TypeVisitor?)
* Anonymous types with more than eight properties. (Can use 'rest' of a tuple, but argh.)
* Empty anonymous types?
* ~~ConstantExpressions of anonymous types~~
* ~~Can I discover anonymous types and build and use my up my constructor/property assignment functions in a single walk of the tree or do I need to do some of that upfront?~~
* Outer result might still need to be an anonymous type as it is used in the client application.